{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "utc-value": {
            "type": "string",
            "defaultValue": "[utcNow()]"
        },
        "subnet-id": {
            "type": "string",
            "metadata": {
                "description": "The unique id of the subnet for the nics."
            }
        }
    },
    "functions": [],
    "variables": {
        "availability-set-deployment-name": "[concat('compute-availabilitysets-',parameters('utc-value'))]",
        "public-ip-addresses-deployment-name": "[concat('network-publicipaddresses-',parameters('utc-value'))]",
        "network-iterfaces-deployment-name":"[concat('network-interfaces-',parameters('utc-value'))]",
        "virtual-machines-deployment-name":"[concat('virtual-machines-',parameters('utc-value'))]",
        "domain-join-ext-deployment-name":"[concat('domain-join-ext-',parameters('utc-value'))]"
    },
    "resources": [
        // Deploy Availability Set
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[variables('availability-set-deployment-name')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri":"https://raw.githubusercontent.com/mariuszdotnet/azure-image-builder-wvd/master/arm-templates/compute-availabilitysets.json",
                    "contentVersion":"1.0.0.0"
                }
            }
        },
        // Deploy Public IP Addresses
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[variables('public-ip-addresses-deployment-name')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri":"https://raw.githubusercontent.com/mariuszdotnet/azure-image-builder-wvd/master/arm-templates/network-publicipaddresses.json",
                    "contentVersion":"1.0.0.0"
                }
            }
        },
        // Deploy Network Interfaces
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[variables('network-iterfaces-deployment-name')]",
            "dependsOn": [
                "[variables('public-ip-addresses-deployment-name')]"
            ],
            "properties": {
                "mode": "Incremental",
                "parameters": {
                   "subnet-id":{"value": "[parameters('subnet-id')]"} 
                },
                "templateLink": {
                    "uri":"https://raw.githubusercontent.com/mariuszdotnet/azure-image-builder-wvd/master/arm-templates/network-networkinterfaces.json",
                    "contentVersion":"1.0.0.0"
                }
            }
        },
        // Deploy Virtual Machines
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[variables('virtual-machines-deployment-name')]",
            "dependsOn": [
                "[variables('network-iterfaces-deployment-name')]",
                "[variables('availability-set-deployment-name')]"
            ],
            "properties": {
                "mode": "Incremental",
                "parameters": {},
                "templateLink": {
                    "uri":"https://raw.githubusercontent.com/mariuszdotnet/azure-image-builder-wvd/master/arm-templates/compute-virtualmachines.json",
                    "contentVersion":"1.0.0.0"
                }
            }
        },
        // Deploy Domain Join Extension
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[variables('domain-join-ext-deployment-name')]",
            "dependsOn": [
                "[variables('virtual-machines-deployment-name')]"
            ],
            "properties": {
                "mode": "Incremental",
                "parameters": {},
                "templateLink": {
                    "uri":"https://raw.githubusercontent.com/mariuszdotnet/azure-image-builder-wvd/master/arm-templates/extensions-jsonaddomainextension.json",
                    "contentVersion":"1.0.0.0"
                }
            }
        }
    ],
    "outputs": {}
}